"use strict";(self.webpackChunkproject_structure=self.webpackChunkproject_structure||[]).push([[460],{842:(e,t,s)=>{function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,{Z:()=>i});class i{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",{duration:t=2e3,type:s="success"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,"timerId",void 0),this.message=e,this.duration=t,this.type=s,this.render()}getTemplate(){return`\n      <div class="notification ${this.type}" style="--value:${this.duration/1e3}s">\n        <div class="timer"></div>\n        <div class="inner-wrapper">\n          <div class="notification-header">${this.type}</div>\n          <div class="notification-body">\n            ${this.message}\n          </div>\n        </div>\n      </div>\n    `}render(){const e=document.createElement("div");e.innerHTML=this.getTemplate(),this.element=e.firstElementChild}show(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.body;i.activeMessage&&i.activeMessage.remove(),e.append(this.element),this.timerId=setTimeout(()=>this.remove(),this.duration),i.activeMessage=this.element}remove(){this.element.remove()}destroy(){clearTimeout(this.timerId),i.activeMessage=null,this.remove()}}n(i,"activeMessage",void 0)},523:(e,t,s)=>{function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,{Z:()=>i});class i{constructor(){let{items:e=[]}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,"element",void 0),n(this,"dragElement",void 0),n(this,"placeholder",void 0),n(this,"left",void 0),n(this,"top",void 0),n(this,"onPointerDown",e=>{const t=e.target.closest(".sortable-list__item");t&&(e.target.closest("[data-grab-handle]")&&(e.preventDefault(),this.onDragStart(e,t)),e.target.closest("[data-delete-handle]")&&(e.preventDefault(),t.remove()))}),n(this,"onPointerMove",e=>{this.moveAt(e.clientX,e.clientY);const t=this.placeholder.previousElementSibling,s=this.placeholder.nextElementSibling,{firstElementChild:n,lastElementChild:i}=this.element,{top:r}=n.getBoundingClientRect(),{bottom:a}=this.element.getBoundingClientRect;if(e.clientY<r)return n.before(this.placeholder);if(e.clientY>a)return i.after(this.placeholder);if(t){const{top:s,height:n}=t.getBoundingClientRect(),i=s+n/2;if(e.clientY<i)return t.before(this.placeholder)}if(s){const{top:t,height:n}=s.getBoundingClientRect(),i=t+n/2;if(e.clientY>i)return s.after(this.placeholder)}}),n(this,"onPointerUp",()=>{const e=[...this.element.children].indexOf(this.placeholder);this.placeholder.replaceWith(this.dragElement),this.dragElement.classList.remove("sortable-list__item_dragging"),this.dragElement.style.cssText="",document.removeEventListener("pointermove",this.onPointerMove),document.removeEventListener("pointerup",this.onPointerUp),e!==this.elementIndex&&this.dispatchEvent("sortable-list-reorder",{from:this.elementIndex,to:e})}),this.items=e,this.render()}getTemplate(){return"\n      <ul class='sortable-list'>\n      </ul>\n    "}getItems(){this.items.map(e=>{e.classList.add("sortable-list__item"),this.element.append(e)})}render(){const e=document.createElement("div");e.innerHTML=this.getTemplate(),this.element=e.firstElementChild,this.getItems(),this.initEventListeners()}onDragStart(e,t){this.left=e.clientX-t.getBoundingClientRect().left,this.top=e.clientY-t.getBoundingClientRect().top,this.dragElement=t,this.elementIndex=[...this.element.children].indexOf(t),this.dragElement.style.width=t.offsetWidth+"px",this.dragElement.style.height=t.offsetHeight+"px",this.dragElement.classList.add("sortable-list__item_dragging"),this.moveAt(e.clientX,e.clientY),this.getPlaceholder(t),document.addEventListener("pointermove",this.onPointerMove),document.addEventListener("pointerup",this.onPointerUp)}getPlaceholder(e){this.placeholder=document.createElement("div"),this.placeholder.className="sortable-list__placeholder",this.placeholder.style.width=e.style.width,this.placeholder.style.height=e.style.height,e.after(this.placeholder)}moveAt(e,t){this.dragElement.style.left=e-this.left+"px",this.dragElement.style.top=t-this.top+"px"}dispatchEvent(e,t){this.element.dispatchEvent(new CustomEvent(e,{bubbles:!0,details:t}))}initEventListeners(){this.element.addEventListener("pointerdown",this.onPointerDown)}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null,this.dragElement=null,this.placeholder=null}}},2:(e,t,s)=>{s.r(t),s.d(t,{default:()=>u});var n=s(523);const i=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var r=s(856);const a=s.p+"src/components/product-form/icon-grab.svg",o=s.p+"src/components/product-form/icon-trash.svg";function l(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class d{constructor(e){l(this,"element",void 0),l(this,"subElements",{}),l(this,"defaultFormData",{title:"",description:"",quantity:1,subcategory:"",status:1,images:[],price:100,discount:0}),l(this,"onSubmit",e=>{e.preventDefault(),this.save()}),l(this,"uploadImage",()=>{const{imageListContainer:e,uploadImage:t}=this.subElements,s=document.createElement("input");s.type="file",s.accept="image/*",s.addEventListener("change",async()=>{const[n]=s.files;if(n){const i=new FormData;i.append("image",n),t.classList.add("is-loading"),ploadImage.disabled=!0;const a=await(0,r.Z)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:i,referrer:""});e.firstElementChild.append(this.getImageItem(a.data.link,n.name)),t.classList.remove("is-loading"),t.disabled=!1,s.remove()}}),s.hidden=!0,document.body.append(s),s.click()}),this.productId=e}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}getCategoriesSelect(){const e=document.createElement("div");e.innerHTML='<select class="form-control" name="subcategory" id="subcategory"></select>';const t=e.firstElementChild;return this.categories.map(e=>e.subcategories.map(s=>{t.append(new Option(`${e.title} > ${s.title}`,s.id))})),t.outerHTML}getTemplate(){return`\n      <div class="product-form">\n      <form data-element="productForm" class="form-grid">\n        <div class="form-group form-group__half_left">\n          <fieldset>\n            <label class="form-label">Название товара</label>\n            <input required\n              id="title"\n              value=""\n              type="text"\n              name="title"\n              class="form-control"\n              placeholder="Название товара">\n          </fieldset>\n        </div>\n        <div class="form-group form-group__wide">\n          <label class="form-label">Описание</label>\n          <textarea required\n            id="description"\n            class="form-control"\n            name="description"\n            data-element="productDescription"\n            placeholder="Описание товара"></textarea>\n        </div>\n        <div class="form-group form-group__wide">\n          <label class="form-label">Фото</label>\n          <div data-element="imageListContainer">\n          </div>\n          <button data-element="uploadImage" type="button" class="button-primary-outline">\n            <span>Загрузить</span>\n          </button>\n        </div>\n        <div class="form-group form-group__half_left">\n          <label class="form-label">Категория</label>\n            ${this.getCategoriesSelect()}\n        </div>\n        <div class="form-group form-group__half_left form-group__two-col">\n          <fieldset>\n            <label class="form-label">Цена ($)</label>\n            <input required\n              id="price"\n              value=""\n              type="number"\n              name="price"\n              class="form-control"\n              placeholder="${this.defaultFormData.price}">\n          </fieldset>\n          <fieldset>\n            <label class="form-label">Скидка ($)</label>\n            <input required\n              id="discount"\n              value=""\n              type="number"\n              name="discount"\n              class="form-control"\n              placeholder="${this.defaultFormData.discount}">\n          </fieldset>\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Количество</label>\n          <input required\n            id="quantity"\n            value=""\n            type="number"\n            class="form-control"\n            name="quantity"\n            placeholder="${this.defaultFormData.quantity}">\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Статус</label>\n          <select id="status" class="form-control" name="status">\n            <option value="1">Активен</option>\n            <option value="0">Неактивен</option>\n          </select>\n        </div>\n        <div class="form-buttons">\n          <button type="submit" name="save" class="button-primary-outline">\n            ${this.productId?"Сохранить":"Добавить"} товар\n          </button>\n        </div>\n      </form>\n    </div>\n    `}async render(){const e=(0,r.Z)("https://course-js.javascript.ru/api/rest/categories?_sort=weight&_refs=subcategory"),t=this.productId?(0,r.Z)("https://course-js.javascript.ru/api/rest/products?id="+this.productId):Promise.resolve([this.defaultFormData]),[s,n]=await Promise.all([e,t]),[i]=n;this.formData=i,this.categories=s;const a=document.createElement("div");return a.innerHTML=this.getTemplate(),this.element=a.firstElementChild,this.subElements=this.getSubElements(this.element),this.formData&&(this.setFormData(),this.createImagesList(),this.initEventListeners()),this.element}getFormData(){const e=["images"],t=["price","quantity","discount","status"],s=Object.keys(this.defaultFormData).filter(t=>!e.includes(t)),n=e=>this.subElements.productForm.querySelector(`[name=${e}]`).value,i={};for(const e of s){const s=n(e);i[e]=t.includes(e)?+s:s}const r=this.subElements.imageListContainer.querySelectorAll(".sortable-table__cell-img");i.images=[],i.id=this.productId;for(const e of r)i.images.push({url:e.src,source:e.alt});return i}setFormData(){const e=["images"];Object.keys(this.defaultFormData).filter(t=>!e.includes(t)).forEach(e=>{this.subElements.productForm.querySelector("#"+e).value=this.formData[e]||this.defaultFormData[e]})}createImagesList(){const{imageListContainer:e}=this.subElements,t=this.formData.images.map(e=>{let{url:t,source:s}=e;return this.getImageItem(t,s)}),s=new n.Z({items:t});e.append(s.element)}getImageItem(e,t){const s=document.createElement("div");return s.innerHTML=`\n      <li class="products-edit__imagelist-item sortable-list__item">\n        <span>\n          <img src=${a} data-grab-handle alt="grab">\n          <img class="sortable-table__cell-img" alt="${i(t)}" src="${i(e)}">\n          <span>${i(t)}</span>\n        </span>\n        <button type="button">\n          <img src=${o} alt="delete" data-delete-handle>\n        </button>\n      </li>`,s.firstElementChild}async save(){const e=this.getFormData(),t=await(0,r.Z)("https://course-js.javascript.ru/api/rest/products",{method:this.productId?"PATCH":"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});this.dispatchEvent(t.id,"success")}dispatchEvent(e,t){const s=this.productId?new CustomEvent("product-updated",{detail:{id:e,status:t}}):new CustomEvent("product-saved",{detail:{status:t}});this.element.dispatchEvent(s)}initEventListeners(){const{productForm:e,uploadImage:t}=this.subElements;e.addEventListener("submit",this.onSubmit),t.addEventListener("click",this.uploadImage)}remove(){this.element.remove()}destroy(){this.remove(),this.element=null,this.subElements=null}}var c=s(842);function m(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class u{constructor(e){m(this,"element",void 0),m(this,"components",{}),m(this,"subElements",{}),this.productId=e[1]}getTemplate(){return`\n      <div class="products-edit">\n        <div class="content__top-panel">\n          <h1 class="page-title">\n            <a href="/products" class="link">Products</a> / ${this.productId?"Edit":"Add"}\n          </h1>\n        </div>\n        <div class="content-box">\n          <div class="product-form" data-element="productForm">\n            </div>\n        </div>\n      </div>`}getSubElements(){return[...this.element.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}initComponents(){const e=new d(this.productId);this.components={productForm:e}}async getComponents(){const e=await this.components.productForm.render();this.subElements.productForm.append(e)}async render(){const e=document.createElement("div");return e.innerHTML=this.getTemplate(),this.element=e.firstElementChild,this.subElements=this.getSubElements(),this.initComponents(),await this.getComponents(),this.initEventListeners(),this.element}initEventListeners(){const{productForm:e}=this.components;e.element.addEventListener("product-updated",e=>{this.showNotification({type:e.detail.status,text:"success"===e.detail.status?"Product was updated":"Product update error"})}),e.element.addEventListener("product-saved",e=>{this.showNotification({type:e.detail.status,text:"success"===e.detail.status?"Product was saved":"Product save error"})})}showNotification(e){new c.Z(e.text,{duration:2e3,type:e.type}).show(this.components.productForm.element)}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null,this.components={},Object.values(this.components).forEach(e=>{e.destroy()})}}},856:(e,t,s)=>{async function n(e,t){let s,n;try{s=await fetch(e.toString(),t)}catch(e){throw new i(s,"Network error has occurred.")}if(!s.ok){let e=s.statusText;try{n=await s.json(),e=n.error&&n.error.message||n.data&&n.data.error&&n.data.error.message||e}catch(e){}let t=`Error ${s.status}: ${e}`;throw new i(s,n,t)}try{return await s.json()}catch(e){throw new i(s,null,e.message)}}s.d(t,{Z:()=>n});class i extends Error{constructor(e,t,s){var n,i,r;super(s),r="FetchError",(i="name")in(n=this)?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof i&&alert(e.reason.message)})}}]);
//# sourceMappingURL=products-edit-index-js-460.js.map